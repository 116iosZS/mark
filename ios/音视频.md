# 音视频

***

- [AVFundation](#AVFundation)
	- [iOS系统中的音频播放方式](#iOS系统中的音频播放方式)
	- [AVAudioPlayer的使用](#AVAudioPlayer的使用)
	- [AVAudioPlayer代理方法](#AVAudioPlayer代理方法)
	- [AVPlayer的使用](#AVPlayer的使用)
	- [播放系统声音](#播放系统声音)
	- [后台播放任务](#后台播放任务)
	- [自定义后台任务](#自定义后台任务)
	- [iOS视频播放](#iOS视频播放)
	- [视频播放常用的通知](#视频播放常用的通知)

<h1 id="AVAudioPlayer的使用"> AVAudioPlayer的使用 </h1>

- 引用框架
- 使用AVAudioPlayer或AVPlayer需要引用AVFoundation类库

	NSBundle *bundle = [NSBundle mainBundle];
	// ⾳音频⽂文件路径
	NSString *urlString = [bundle pathForResource:@"tell me why" ofType:@"mp3"];
	// 初始化本地的url
	NSURL *url = [[NSURL alloc] initFileURLWithPath:urlString]; // 初始化⾳音频对象
	AVAudioPlayer *player = [[AVAudioPlayer alloc] initWithContentsOfURL:url error:nil];
	// 分配播放所需的资源,并将其加⼊入内部播放队列 [player prepareToPlay];
	// 播放
	if ([player play]){
	    NSLog(@"正在播放");
	}

<h2 id="AVAudioPlayer代理方法"> AVAudioPlayer代理方法 </h2>

	- (void)audioPlayerDidFinishPlaying:(AVAudioPlayer*)player successfully:(BOOL)flag {
	    // 播放结束时执⾏行的动作
	}

	- (void)audioPlayerDecodeErrorDidOccur:(AVAudioPlayer*)player error: (NSError *)error {
	    // 解码错误执⾏行的动作
	}

	- (void)audioPlayerBeginInterruption:(AVAudioPlayer*)player {
	    // 处理中断的代码
	}    

	- (void)audioPlayerEndInterruption:(AVAudioPlayer*)player {
	    // 处理中断结束的代码
	}

<h2 id="AVPlayer的使用"> AVPlayer的使用 </h2>

	NSString *urlString = @"http://zhangmenshiting2.baidu.com/data2/music/ 1736524/1736524.mp3? xcode=4c984fdae3c1bad69e17a9d95288ce1e&mid=0.33322142677174";
	// 初始化远程url
	NSURL *url = [NSURL URLWithString:urlString]; // 初始化播放器
	AVPlayer *player = [[AVPlayer alloc] initWithURL:url]; // 播放
	[player play];

<h2 id="播放系统声音"> 播放系统声音 </h2>

格式为:caf/wav/aiff格式,且时长小于30s

	NSBundle *bundle = [NSBundle mainBundle];
	NSString *path = [bundle pathForResource:@"44th Street Medium" ofType:@"caf"];
	// 初始化本地⽂文件url
	NSURL *url = [NSURL fileURLWithPath:path];
	UInt32 soundID;
	// 将URL所在的⾳音频⽂文件注册为系统声⾳音,soundID⾳音频ID标⽰示该⾳音频
	AudioServicesCreateSystemSoundID((CFURLRef)url, &soundID);
	// 播放⾳音频
	AudioServicesPlaySystemSound(soundID);
	// 播放系统震动
	AudioServicesPlaySystemSound(kSystemSoundID_Vibrate);

<h2 id="后台播放任务"> 后台播放任务 </h2>

- 当你的应用程序在后台时(被挂起), 在iOS系统(4.0之后)允许你做三件事:播放音频(audio),位置信息以及voip(网络电话),播放音频
- 在plist文件中添加“UIBackgroundMode”属性,值为“audio” , 设置AVAudioSession模式,播放音频时,通常将属性设置为AVAudioSessionCategoryPlayback(音频播放之前设置)

	NSError *error;
	AVAudioSession *audionSession = [AVAudioSession sharedInstance];
	[audionSession setCategory:AVAudioSessionCategoryPlayback
	error:&error];

<h2 id="自定义后台任务"> 自定义后台任务 </h2>

	- (void)applicationDidEnterBackground:(UIApplication *)application
	{
	    UIApplication *application = [UIApplication sharedApplication];
	    //启动y一个后台任务
	    bgTask = [application beginBackgroundTaskWithExpirationHandler:^(void) {
	        //当该任务超时回调该block块
	        //结束该任务
	        [application endBackgroundTask:bgTask];
	        bgTask = UIBackgroundTaskInvalid;
	    }];
	}

	// 程序进⼊入后台调⽤用
	- (void)applicationDidEnterBackground:(UIApplication *)application {
	    // 开启y一个后台任务,避免程序被挂起
	    bgTask = [application beginBackgroundTaskWithExpirationHandler:^ {
	                [application endBackgroundTask:bgTask];
	                bgTask = UIBackgroundTaskInvalid;
	            }];
	    // 开启新的线程
	    [[[NSOperationQueue alloc] init] addOperationWithBlock:^ {
	        // 开启定时器监听后台运⾏行时间
	        [NSTimer scheduledTimerWithTimeInterval:1 target:self repeats:YES];
	  }];
	}
	selector:@selector(timerAction) userInfo:self[[NSRunLoop currentRunLoop] run];

	- (void)timerAction {
	    _count++;
	    NSLog(@"%d",__count);
	    //因为y一个任务只能保持600秒,所以当500秒的时,新开y一个新的任务 if (__count % 500 == 0) {
	      UIApplication *application = [UIApplication sharedApplication];
	      bgTask = [application beginBackgroundTaskWithExpirationHandler:^(void) {
	          [application endBackgroundTask:bgTask];
	          bgTask = UIBackgroundTaskInvalid;
	      }];
	}

<h2 id="iOS视频播放"> iOS视频播放 </h2>

iOS内置了视频播放器,我们可以通过使用MPMoviePlayerController或者 MPMoviePlayerViewController类(视图控制器)来播放视频(含流媒体视频播 放),两者使用也较为简单

- 需引入“MediaPlayer.framewrok”库
- MPMoviePlayerController播放器可以任意修改播放页面尺寸
- MPMoviePlayerViewController类是一个特殊的视图控制器类,它包含了一个播 放器(MPMoviePlayerController)
 
MPMoviePlayerController的使用

	// 初始化url
	NSURL *url = [NSURL URLWithString:@"http://tv.flytv.com.cn/seg/ 17.m3u8"];
	// 初始化视频播放
	MPMoviePlayerController *moviePlayer = [[MPMoviePlayerController alloc] initWithContentURL:url];
	// 将视频播放视图加⼊入
	[self.view addSubview:moviePlayer.view];
	moviePlayer.view.frame = self.view.bounds;
	// 开始播放
	[moviePlayer play];
	

	// 初始化url
	NSURL *url = [NSURL URLWithString:@"http://tv.flytv.com.cn/seg/ 17.m3u8"];
	// 初始化播放器控制器
	MPMoviePlayerViewController *moviePlayer = [[MPMoviePlayerViewController alloc]
	initWithContentURL:url];
	// 模态窗⼝口弹出播放器
	[self presentModalViewController:moviePlayer animated:YES]; [moviePlayer release];

<h2 id="视频播放常用的通知"> 视频播放常用的通知 </h2>

- 视频播放结束的通知 MPMoviePlayerPlaybackDidFinishNotification
- 视频播放状态改变的通知 MPMoviePlayerPlaybackStateDidChangeNotification
- 视频加载状态改变的通知 MPMoviePlayerLoadStateDidChangeNotification

***
